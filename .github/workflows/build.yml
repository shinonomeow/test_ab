name: Build Docker Test

on:
  push:
  pull_request:

jobs:
  build-docker:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        platform:
          - linux/amd64
          - linux/arm64
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        id: buildx
        uses: docker/setup-buildx-action@v3

      - name: Build test
        uses: docker/build-push-action@v6
        with:
          context: .
          builder: ${{ steps.buildx.outputs.name }}
          platforms: ${{ matrix.platform }}
          push: false
          load: true
          tags: test/auto_bangumi:test
          cache-from: type=gha, scope=${{ github.workflow }}-${{ matrix.platform }}
          cache-to: type=gha, scope=${{ github.workflow }}-${{ matrix.platform }}

      - name: Show image size
        run: |
          echo "=== Docker Image Size (${{ matrix.platform }}) ==="
          docker images test/auto_bangumi:test --format "table {{.Repository}}:{{.Tag}}\t{{.Size}}"
          echo ""
          echo "=== Detailed Size Info ==="
          docker image inspect test/auto_bangumi:test --format '{{.Size}}' | awk '{printf "Size: %.2f MB\n", $1/1024/1024}'

  build-armv7:
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        id: buildx
        uses: docker/setup-buildx-action@v3

      - name: Build armv7
        uses: docker/build-push-action@v6
        with:
          context: .
          builder: ${{ steps.buildx.outputs.name }}
          platforms: linux/arm/v7
          push: false
          load: true
          tags: test/auto_bangumi:test-armv7
          cache-from: type=gha, scope=${{ github.workflow }}-armv7
          cache-to: type=gha, scope=${{ github.workflow }}-armv7

      - name: Show image size
        run: |
          echo "=== Docker Image Size (linux/arm/v7) ==="
          docker images test/auto_bangumi:test-armv7 --format "table {{.Repository}}:{{.Tag}}\t{{.Size}}"
          echo ""
          echo "=== Detailed Size Info ==="
          docker image inspect test/auto_bangumi:test-armv7 --format '{{.Size}}' | awk '{printf "Size: %.2f MB\n", $1/1024/1024}'
